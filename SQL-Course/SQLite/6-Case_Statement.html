<h1>CASE Statements</h1>
<h3>5.1 Categorizing Wind Speed</h3>
<p>You can use a <code>CASE</code> statement to turn a column value into another value based on conditions. For instance, we can turn different <code>wind_speed</code> ranges into <code>HIGH</code>, <code>MODERATE</code>, and <code>LOW</code> categories.</p>
<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">report_code</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span><span class="p">,</span><span class="w"> </span><span class="k">day</span><span class="p">,</span><span class="w"> </span><span class="n">wind_speed</span><span class="p">,</span>

<span class="k">CASE</span>
<span class="w">   </span><span class="k">WHEN</span><span class="w"> </span><span class="n">wind_speed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span>
<span class="w">   </span><span class="k">WHEN</span><span class="w"> </span><span class="n">wind_speed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;MODERATE&#39;</span>
<span class="w">   </span><span class="k">WHEN</span><span class="w"> </span><span class="n">wind_speed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;LOW&#39;</span>
<span class="w">   </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span>
<span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wind_severity</span>

<span class="k">FROM</span><span class="w"> </span><span class="n">station_data</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">wind_speed</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span>
</code></pre></div>

<h3>5.2 More Efficient Way To Categorize Wind Speed</h3>
<p>We can actually omit <code>AND wind_speed &lt; 40</code> from the previous example because each <code>WHEN</code>/<code>THEN</code> is evaluated from top-to-bottom. The first one it finds to be true is the one it will go with, and stop evaluating subsequent conditions.</p>
<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">report_code</span><span class="p">,</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span><span class="p">,</span><span class="w"> </span><span class="k">day</span><span class="p">,</span><span class="w"> </span><span class="n">wind_speed</span><span class="p">,</span>

<span class="k">CASE</span>
<span class="w">   </span><span class="k">WHEN</span><span class="w"> </span><span class="n">wind_speed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span>
<span class="w">   </span><span class="k">WHEN</span><span class="w"> </span><span class="n">wind_speed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;MODERATE&#39;</span>
<span class="w">   </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;LOW&#39;</span>
<span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wind_severity</span>

<span class="k">FROM</span><span class="w"> </span><span class="n">station_data</span>
</code></pre></div>

<h3>5.3 Using CASE with GROUP BY</h3>
<p>We can use <code>GROUP BY</code> in conjunction with a <code>CASE</code> statement to slice data in more ways, such as getting the record count by <code>wind_severity</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span>

<span class="k">CASE</span>
<span class="w">   </span><span class="k">WHEN</span><span class="w"> </span><span class="n">wind_speed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span>
<span class="w">   </span><span class="k">WHEN</span><span class="w"> </span><span class="n">wind_speed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;MODERATE&#39;</span>
<span class="w">   </span><span class="k">WHEN</span><span class="w"> </span><span class="n">wind_speed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;LOW&#39;</span>
<span class="w">   </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span>
<span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">wind_severity</span><span class="p">,</span>
<span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">record_count</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">station_data</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">wind_severity</span><span class="p">;</span>
</code></pre></div>

<p>Also, some wind_speed values are NULL, so without an <code>ELSE</code> any records that do not meet a condition will turn out to be NULL. </p>
<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span>

<span class="k">CASE</span>
<span class="w">   </span><span class="k">WHEN</span><span class="w"> </span><span class="n">wind_speed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span>
<span class="w">   </span><span class="k">WHEN</span><span class="w"> </span><span class="n">wind_speed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;MODERATE&#39;</span>
<span class="w">   </span><span class="k">WHEN</span><span class="w"> </span><span class="n">wind_speed</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;LOW&#39;</span>

<span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">wind_severity</span><span class="p">,</span>
<span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">record_count</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">station_data</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">wind_severity</span><span class="p">;</span>
</code></pre></div>

<h3>5.4 "Zero/Null" Case Trick</h3>
<p>There is really no way to create multiple aggregations with different conditions unless you know a trick with the <code>CASE</code> statement. If you want to find two total precipitation, with and without tornado precipitations, for each year and month, you have to do separate queries.</p>
<p><strong>Tornado Precipitation</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span><span class="p">,</span>
<span class="k">SUM</span><span class="p">(</span><span class="n">precipitation</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tornado_precipitation</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">station_data</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">tornado</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="k">AND</span><span class="w"> </span><span class="k">year</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1990</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span>
</code></pre></div>

<p><strong>Non-Tornado Precipitation</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span><span class="p">,</span>
<span class="k">SUM</span><span class="p">(</span><span class="n">precipitation</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">non_tornado_precipitation</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">station_data</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">tornado</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span>
<span class="k">AND</span><span class="w"> </span><span class="k">year</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1990</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span>
</code></pre></div>

<p>But you can use a single query using a <code>CASE</code> statement that sets a value to 0 if the condition is not met. That way it will not impact the sum.</p>
<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span><span class="p">,</span>
<span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">tornado</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">precipitation</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tornado_precipitation</span><span class="p">,</span>
<span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">tornado</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">precipitation</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">non_tornado_precipitation</span>

<span class="k">FROM</span><span class="w"> </span><span class="n">station_data</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">year</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1990</span>

<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span>
</code></pre></div>

<p>Many folks who are not aware of the zero/null case trick will resort to derived tables (not covered in this class but covered in <em>Advanced SQL for Data Analysis</em>), which adds an unnecessary amount of effort and mess.</p>
<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="k">year</span><span class="p">,</span>
<span class="n">t</span><span class="p">.</span><span class="k">month</span><span class="p">,</span>
<span class="n">t</span><span class="p">.</span><span class="n">tornado_precipitation</span><span class="p">,</span>
<span class="n">non_t</span><span class="p">.</span><span class="n">non_tornado_precipitation</span>

<span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">precipitation</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tornado_precipitation</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">station_data</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">tornado</span><span class="w"> </span><span class="o">=</span><span class="mi">1</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="k">year</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1990</span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span>
<span class="p">)</span><span class="w"> </span><span class="n">t</span>

<span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span>

<span class="p">(</span><span class="w">   </span><span class="k">SELECT</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span><span class="p">,</span>
<span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="n">precipitation</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">non_tornado_precipitation</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">station_data</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">tornado</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="k">year</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1990</span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="k">month</span>
<span class="p">)</span><span class="w"> </span><span class="n">non_t</span>
</code></pre></div>

<h3>5.5 Using Null in a CASE to conditionalize MIN/MAX</h3>
<p>Since <code>NULL</code> is ignored in SUM, MIN, MAX, and other aggregate functions, you can use it in a <code>CASE</code> statement to conditionally control whether or not a value should be included in that aggregation.</p>
<p>For instance, we can split up max precipitation when a tornado was present vs not present.</p>
<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="k">year</span><span class="p">,</span>
<span class="k">MAX</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">tornado</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">precipitation</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">max_non_tornado_precipitation</span><span class="p">,</span>
<span class="k">MAX</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">tornado</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">precipitation</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">max_tornado_precipitation</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">station_data</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">year</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1990</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">year</span>
</code></pre></div>

<p><em>Switch to slides for exercise</em></p>
<h3>Exercise 5.1</h3>
<p>SELECT  the report_code, year, quarter, and temperature, where a “quarter” is “Q1”, “Q2”, “Q3”, or “Q4” reflecting months 1-3, 4-6, 7-9, and 10-12 respectively.</p>
<p><strong>ANSWER:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span>

<span class="n">report_code</span><span class="p">,</span>
<span class="k">year</span><span class="p">,</span>

<span class="k">CASE</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">month</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Q1&#39;</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">month</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Q2&#39;</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">month</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Q3&#39;</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">month</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Q4&#39;</span>
<span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">quarter</span><span class="p">,</span>

<span class="n">temperature</span>

<span class="k">FROM</span><span class="w"> </span><span class="n">STATION_DATA</span>
</code></pre></div>

<h3>Exercise 5.2</h3>
<p>Get the average temperature by quarter and month, where a “quarter” is “Q1”, “Q2”, “Q3”, or “Q4” reflecting months 1-3, 4-6, 7-9, and 10-12 respectively.</p>
<p><strong>ANSWER</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span>
<span class="k">year</span><span class="p">,</span>

<span class="k">CASE</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">month</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Q1&#39;</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">month</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Q2&#39;</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">month</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Q3&#39;</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">month</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Q4&#39;</span>
<span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">quarter</span><span class="p">,</span>

<span class="k">AVG</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_temp</span>

<span class="k">FROM</span><span class="w"> </span><span class="n">STATION_DATA</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span>
</code></pre></div>